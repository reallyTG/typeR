---
title: "Data Builder"
output: html_notebook
---

```{r}
source("../code/data_processing.R")
```

```{r}
# load the data
psp <- read_rds("../data/per_sig_partial.RDS")

# get rid of empties
# they are due to packages having no data, this may get resolved as the prl3 run finishes
psp <- psp[!psp$pkg == "no_data",]

# do this otherwise there are lists
psp <- lists_to_chars_sig_df(psp)
```

```{r}
# first, turn specials, closures, and builtins to functions
psp <- transform_new_df_w_TS_map(psp, type_map_to_fun)
```

```{r}
# make it T0
psp_L0 <- transform_new_df_w_TS_map(psp, type_map_T0_to_r)
```

```{r}
# write it to file for Java processing
write_csv(psp_L0, "../data/partial_L0.csv")
```

```{r}
# read in new one
psp_L0 <- read_csv("../data/partial_L0_subtype.csv")

# remove SUBTYPE rows
psp_L0 <- psp_L0[!psp_L0$pkg == "SUBTYPE",]
```

```{r}
# write L1 (which is just psp) to file for Java
write_csv(psp, "../data/partial_L1.csv")

# go to terminal, gzip it for Java
```

```{r}
# read it back
psp <- read_csv("../data/partial_L1_subtype.csv")

# remove SUBTYPE rows
psp <- psp[!psp$pkg == "SUBTYPE",]
```

```{r}
# collapse
# make sure the right function is uncommented in Java

psp_col <- read_csv("../data/partial_L1_collapsed.csv.gz")
psp_L0_col <- read_csv("../data/partial_L0_collapsed.csv.gz")
```

```{r}
# arg counts
# again, Java
L0_arg_sig_c <- read_csv("../data/partial_L0_arg_sig_counts.csv")
L1_arg_sig_c <- read_csv("../data/partial_L1_arg_sig_counts.csv")

# sort
L0_arg_sig_c[order(-L0_arg_sig_c$count),] -> L0_arg_sig_c
L1_arg_sig_c[order(-L1_arg_sig_c$count),] -> L1_arg_sig_c

# rm []
L0_arg_sig_c[1,"count"] <- 0
L1_arg_sig_c[1,"count"] <- 0

# re sort
L0_arg_sig_c[order(-L0_arg_sig_c$count),] -> L0_arg_sig_c
L1_arg_sig_c[order(-L1_arg_sig_c$count),] -> L1_arg_sig_c

# percentages
L0_arg_sig_c$perc_tot <- round(L0_arg_sig_c$count / sum(L0_arg_sig_c$count) * 100, 2)
L1_arg_sig_c$perc_tot <- round(L1_arg_sig_c$count / sum(L1_arg_sig_c$count) * 100, 2)

# collapse the obvious signatures
L0_arg_sig_c <- new_df_count_collape_arg_sigs(L0_arg_sig_c, "L0")
L1_arg_sig_c <- new_df_count_collape_arg_sigs(L1_arg_sig_c, "L1")

# poly arg counts only
L0_poly_sig <- L0_arg_sig_c[L0_arg_sig_c$arg_sig %>% strsplit(split=",") %>% lapply(function(x) length(x) != 1) %>% unlist, ]
L1_poly_sig <- L1_arg_sig_c[L1_arg_sig_c$arg_sig %>% strsplit(split=",") %>% lapply(function(x) length(x) != 1) %>% unlist, ]

# display all args 
L0_arg_sig_c[1:10,] %>% ready_print_count_fun %>% xtable %>% print(include.rownames=F)
L1_arg_sig_c[1:10,] %>% ready_print_count_fun %>% xtable %>% print(include.rownames=F)

# display poly
L0_poly_sig[1:10,] %>% ready_print_count_fun %>% xtable %>% print(include.rownames=F)
L1_poly_sig[1:10,] %>% ready_print_count_fun %>% xtable %>% print(include.rownames=F)
```

```{r}
# all pckg (w/ dups)
pf_L0 <- psp_L0 %>% mutate(pkgfun = paste(pkg, fun, sep="::")) %>% select(pkgfun)
pf_L1 <- psp %>% mutate(pkgfun = paste(pkg, fun, sep="::")) %>% select(pkgfun)

# tot fun counts
pf_L0 %>% unique %>% nrow -> tot_L0_funs
pf_L1 %>% unique %>% nrow -> tot_L1_funs

# poly fun counts
pf_L0[duplicated(pf_L0),] %>% unique -> poly_L0_funs
pf_L1[duplicated(pf_L1),] %>% unique -> poly_L1_funs

poly_L0_funs_c <- poly_L0_funs %>% nrow
poly_L1_funs_c <- poly_L1_funs %>% nrow

# mono fun count (sanity check)
setdiff(pf_L0 %>% unique, poly_L0_funs) %>% nrow -> mono_L0_funs_c
setdiff(pf_L1 %>% unique, poly_L1_funs) %>% nrow -> mono_L1_funs_c

data.frame(`Signature Type`=c("Monomorphic", "Total Seen"), Count=paste0(c(mono_L0_funs_c/1000, tot_L0_funs/1000) %>% as.integer, "K"), Percentage=c(paste0(round(mono_L0_funs_c/tot_L0_funs * 100, 1), "%"), "---")) %>% xtable %>% print(include.rownames=F)

data.frame(`Signature Type`=c("Monomorphic", "Total Seen"), Count=paste0(c(mono_L1_funs_c/1000, tot_L1_funs/1000) %>% as.integer, "K"), Percentage=c(paste0(round(mono_L1_funs_c/tot_L1_funs * 100, 1), "%"), "---")) %>% xtable %>% print(include.rownames=F)
```

```{r}
# arg poly count

# L0
data.frame(`Signature Type`=c("Monomorphic", "Total Seen"), Count=c(L0_arg_sig_c$count %>% sum - L0_poly_sig$count %>% sum, L0_arg_sig_c$count %>% sum), Percentage=c(paste0(round(100 * (1 - (L0_poly_sig$count %>% sum / L0_arg_sig_c$count %>% sum)), 1), "%"), "---")) %>% xtable %>% print(include.rownames=F)

# L1
data.frame(`Signature Type`=c("Monomorphic", "Total Seen"), Count=c(L1_arg_sig_c$count %>% sum - L1_poly_sig$count %>% sum, L1_arg_sig_c$count %>% sum), Percentage=c(paste0(round(100 * (1 - (L1_poly_sig$count %>% sum / L1_arg_sig_c$count %>% sum)), 1), "%"), "---")) %>% xtable %>% print(include.rownames=F)

```

```{r}
prim_scal <- c("sD", "sL", "sC", "sX", "sI", "sR")
# compute scalars 
L1_sc_c <- L1_arg_sig_c[unlist(lapply(L1_arg_sig_c$arg_sig, function(s) nchar(s) == 2 && substr(s, 1, 1) == "s")), ]
L1_sc_c <- L1_sc_c[L1_sc_c$arg_sig %in% prim_scal,]
num_scal <- sum(L1_sc_c$count)

percent_scalar_mono <- round( 100 * num_scal / sum(L1_arg_sig_c$count), 1)
```

```{r}
# L2 Time
psp_L2 <- read_csv("../data/partial_L1_L2.csv.gz")
psp_L2 <- psp_L2[!psp_L2$pkg == "SUBTYPE",]

# L2 collapsed?
what <- read_csv("../data/partial_L1_sanitized_class_collapsed.csv.gz")
```

```{r}
# arg sig counts?
L2_arg_sig_c <- read_csv("../data/partial_L1_sanitized_class_arg_sig_counts_L2.csv.gz")

# sort
L2_arg_sig_c[order(-L2_arg_sig_c$count),] -> L2_arg_sig_c

# rm []/[]/[]
L2_arg_sig_c[1,"count"] <- 0

# resort
L2_arg_sig_c[order(-L2_arg_sig_c$count),] -> L2_arg_sig_c

# %
L2_arg_sig_c$perc_tot <- round(L2_arg_sig_c$count / sum(L2_arg_sig_c$count) * 100, 1)

# collapse obvious subtypes
# gets rid of stuff in the first box
L2_arg_sig_c <- new_df_count_collape_arg_sigs_L2(L2_arg_sig_c)

# what counts do we want?
# split typeclassattr into type class attr
L2_split <- split_L2_df(L2_arg_sig_c)

# display some
L2_split[1:10,] %>% ready_print_count_fun_L2 %>% xtable %>% print(include.rownames=F)

L2_split %>% filter(Class != "") %>% slice(1:10) %>% as.data.frame %>% ready_print_count_fun_L2 %>% xtable %>% print(include.rownames=F)
```